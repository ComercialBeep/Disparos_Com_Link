import pandas as pd
import pywhatkit as kit
import urllib.parse
import time

# Caminho do arquivo da planilha
file_path = r"C:\Users\Beep Saude.BEEP1441\OneDrive\Documentos\Sales\RPA\Campanhas.xlsx"
sheet_name = 'Campanhas'  # Nome da aba da planilha correta

# Caminho da imagem
image_path = r"C:\Users\Beep Saude.BEEP1441\OneDrive\Documentos\Sales\RPA\meningo70.png"

# C√≥digo do pa√≠s
codigo_pais = '+55'  # Altere conforme o c√≥digo do pa√≠s necess√°rio

# Verificar se a planilha existe no arquivo
xls = pd.ExcelFile(file_path)
if sheet_name in xls.sheet_names:
    df = pd.read_excel(file_path, sheet_name=sheet_name)
else:
    raise ValueError(f"A planilha '{sheet_name}' n√£o foi encontrada no arquivo.")

# Definir o hor√°rio limite (21h)
hora_limite = 21

# Iterar sobre cada linha da planilha
for index, row in df.iterrows():
    nome = row['Nome']  # Ajuste o nome da coluna conforme necess√°rio
    telefone = str(row['Fone 1'])  # Ajuste o nome da coluna conforme necess√°rio
    exec_nome = row['Executivo_nome']  # Nome do executivo respons√°vel
    exec_telefone = str(row['Executivo_telefone'])  # Telefone do executivo respons√°vel

    # Formatar o telefone do executivo para o padr√£o internacional
    if not exec_telefone.startswith('+'):
        exec_telefone = codigo_pais + exec_telefone

    # Formatar o telefone do m√©dico para o padr√£o internacional
    if not telefone.startswith('+'):
        telefone = codigo_pais + telefone

    # Codificar o nome do executivo para URL
    exec_nome_encoded = urllib.parse.quote(exec_nome)

    # Construir a mensagem de texto com link personalizado para o executivo
    link_executivo = f"fale com seu executivo atrav√©s do link: https://wa.me/{exec_telefone}?text=Ol√°%20{exec_nome_encoded},%20gostaria%20de%20saber%20mais%20sobre%20o%20Pacote%20Meningites%20ACWY%20+%20B."

    # Nova mensagem
    mensagem = (f"Ol√°, *{nome}*!\n\n"
                "O c√≥digo *MENINGO70* est√° garantindo desconto no Pacote Meningites ACWY + B* aqui na Beep! Com a condi√ß√£o especial, o valor cai de R$ 976 para R$ 906.\n\n"
                "üö® Compartilhe com os seus pacientes! √â por tempo limitado.\n\n"
                "Prote√ß√£o para toda a fam√≠lia üõ°Ô∏è\n\n"
                "A meningite pode afetar pessoas de todas as idades. Por isso, √© fundamental que todos estejam protegidos.\n\n"
                "*Valor promocional referente a uma dose de cada vacina Pfizer. Os pre√ßos podem variar conforme a regi√£o. Veja condi√ß√µes no site.\n\n"
                f"Se precisar de mais informa√ß√µes, {link_executivo}")

    # Enviar mensagem pelo WhatsApp com imagem
    try:
        print(f"Enviando mensagem para {nome} no n√∫mero {telefone}")
        kit.sendwhats_image(receiver=telefone, img_path=image_path, caption=mensagem, wait_time=10, tab_close=True)
        print(f"Mensagem enviada para {nome} com sucesso!")
    except Exception as e:
        print(f"Erro ao enviar mensagem para {nome}: {e}")
        continue  # Pular esta itera√ß√£o em caso de erro

    # Esperar um pouco antes de enviar a pr√≥xima mensagem
    time.sleep(5)  # Ajuste o tempo de espera conforme necess√°rio

print("Processo conclu√≠do!")
